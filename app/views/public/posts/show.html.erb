<%= stylesheet_link_tag 'post_show' %>
<%= render 'layouts/search' %>
<div class="container mt-5 text-center">
  <% if flash[:notice] %>
    <div class="alert alert-success">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <h1 class="mb-3">投稿詳細</h1>
  <div class="mb-3">
    <% if admin_signed_in? %>
      <%= link_to "会員名：【#{@post.user.name}】さんの投稿一覧に戻る", admin_user_posts_path(@post.user), class: "btn btn-secondary mx-1" %>
    <% end %>
    <% if user_signed_in? %>
      <%= link_to "マイページに戻る", user_path(current_user), class: "btn btn-yamabuki me-2" %>
      <%= link_to "投稿する", new_post_path, class: "btn btn-sakura me-2" %>
      <%= link_to "みんなの投稿をみる", posts_path, class: "btn btn-sky" %>
    <% end %>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <!-- 投稿内容 -->
    <div class="card card-custom p-3 mb-3">
      <div class="text-center">
        <% if @post.image.attached? %>
          <%= image_tag @post.image, size: "300x300", class: "img-fluid" %>
        <% else %>
          <%= image_tag 'no_image.png', size: "300x300", class: "img-fluid" %>
        <% end %>
        <p><%= link_to @post.user.name, user_path(@post.user) %>さんのご朱印難易度：</p>
        <div id="post_raty_<%= @post.id %>" data-star="<%= @star_rating %>"></div>
        <p>コメントの平均点: <%= @average_rating %>点</p>
        <h5 class="card-title">寺社名：<%= @post.title %></h5>
      </div>
      <div class="card-body">
        <p class="card-text"><span><i class="fa-solid fa-location-dot"></i><%= @post.address %></p></span>
        <div id="map" class="map"></div>
        <p class="card-text">ご朱印はいただける？：<%= @post.receive_shuin ? 'はい' : 'いいえ' %></p>
        <p class="card-text">タグ：
          <% @post.tag_list.each do |tag| %>
            <%= link_to tag, tagged_posts_path(tag), class: "badge badge-custom" %>
          <% end %>
        </p>
        <div class="d-flex justify-content-end">
          <div class="wish_list" id="wish_list-<%= @post.id %>">
            <%= render partial: 'layouts/wish_list', locals: { post: @post } %>
          </div>
        </div>
        <p class="card-text">投稿者：<%= link_to @post.user.name, user_path(@post.user) %></p>
        <% if @post.user == current_user %>
          <div class="mt-3 d-flex justify-content-end">
            <%= link_to "編集", edit_post_path(@post), class: "btn btn-primary btn-sm me-2" %>
            <%= link_to "削除", post_path(@post), method: :delete, data: { confirm: "本当に削除しますか？" }, class: "btn btn-danger btn-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <!-- 右側：コメント入力フォームとコメント一覧 -->
    <div class="row">
      <div class="col-md-12">
        <!-- コメント入力フォーム -->
        <div class="card card-custom p-3 mb-3">
          <%= form_with(model: [@post, @comment], method: :post, local: true, html: { id: 'commentForm' }) do |f| %>
            <div class="mb-3">
              <p>ご朱印をいただけるまでの難易度はどれぐらいでしたか？</p>
              <div class="form-group" id="comment_raty"></div>
              <%= f.text_area :comment, placeholder: "コメントを入力してください", class: "form-control", id: "commentField" %>
              <%= f.hidden_field :post_id, value: @post.id %>
              <div class="invalid-feedback">コメントを入力してください。</div>
            </div>
            <div>
              <%= f.submit "コメントする", class: "btn btn-success" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- コメント一覧 -->
    <div class="row">
      <div class="col-md-12">
        <div class="card card-custom">
          <div class="card-body">
            <h5>コメント一覧</h5>
            <% if @comments.empty? %>
              <div class="card card-custom p-3">
                <p>まだコメントがありません</p>
              </div>
            <% else %>
              <% @comments.reverse_each do |comment| %>
                <div class="card card-custom comment-card p-3 mb-3">
                  <div id="comment_raty_<%= comment.id %>" data-star="<%= comment.star %>"></div>
                  <div><strong>投稿者：<%= link_to comment.user.name, user_path(comment.user) %></strong></div>
                  <div><%= comment.comment %></div>
                  <div class="text-muted"><%= comment.created_at.strftime('%Y/%m/%d') %></div>
                  <% if current_user == comment.user %>
                    <div class="mt-2">
                      <%= link_to "削除", post_comment_path(comment.post, comment), method: :delete, data: { confirm: "本当に削除しますか？" }, class: "btn btn-danger btn-sm" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('turbolinks:load', function() {
    var allCards = document.querySelectorAll('.card-custom');
    allCards.forEach(function(card, index) {
      setTimeout(function() {
        card.classList.add('show');
      }, index * 100);
    });

    document.getElementById('commentForm').addEventListener('submit', function(event) {
      var commentField = document.getElementById('commentField');
      if (commentField.value.trim() === "") {
        commentField.classList.add('is-invalid');
        event.preventDefault();
      } else {
        commentField.classList.remove('is-invalid');
      }
    });
  });
</script>

<!-- 評価javascript -->
<%= render 'layouts/star' %>
<%= render 'layouts/comment_star' %>

<!-- 評価（コメント入力時用）-->
<script>
document.addEventListener('turbolinks:load', function() {
  let elem = document.querySelector('#comment_raty');
  if (elem) {
    elem.innerHTML = '';
    let opt = {
      starOn: "<%= asset_path('star-on.png') %>",
      starOff: "<%= asset_path('star-off.png') %>",
      starHalf: "<%= asset_path('star-half.png') %>",
      half: true,
      scoreName: 'comment[star]'
    };
    raty(elem, opt);
  }
});
</script>

<script>
  // ページの読み込み時にマップのサイズを調整する
  document.addEventListener('DOMContentLoaded', adjustMapSize);

  // ウィンドウのリサイズ時にもマップのサイズを調整する
  window.addEventListener('resize', adjustMapSize);

  function adjustMapSize() {
    var map = document.getElementById('map');
    var cardBody = document.querySelector('.card-body');

    // マップの初期値の高さをカードの高さに合わせる
    map.style.height = cardBody.clientHeight + 'px';
  }
</script>

<%= javascript_pack_tag 'map', 'data-turbolinks-track': 'reload' %>